{% extends "base_auth.html" %}
{% load i18n %}
{% load allauth %}
{% load static %}

{% block head_title %}
    {% trans "Verify Your Email Address" %}
{% endblock head_title %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 px-4 py-12">
    <div class="bg-white shadow-2xl rounded-2xl p-10 max-w-lg w-full text-center">

        <!-- Logo -->
        <div class="mb-6">
            <img src="{% static 'img/powermason_logo.png' %}" alt="Powermason Logo" class="h-20 w-auto mx-auto">
        </div>

        <!-- Title -->
        <h1 class="text-3xl font-bold text-gray-900 mb-6">
            {% trans "Verify Your Email Address" %}
        </h1>

        <!-- Show messages if any -->
        {% if messages %}
            {% for message in messages %}
                <div class="mb-4 p-4 rounded-lg flex items-center space-x-3 {% if message.tags == 'error' %}bg-red-100 border border-red-300 text-red-700{% elif message.tags == 'success' %}bg-green-100 border border-green-300 text-green-700{% else %}bg-blue-100 border border-blue-300 text-blue-700{% endif %}">
                    <!-- Icon based on message type -->
                    {% if message.tags == 'error' %}
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    {% elif message.tags == 'success' %}
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    {% else %}
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    {% endif %}
                    
                    <span class="text-sm font-medium">{{ message }}</span>
                    
                    <!-- Dismissible button -->
                    <button onclick="this.parentElement.remove()" class="ml-auto text-current hover:opacity-70">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Intro Text -->
        {% if request.session.unverified_email %}
            <p class="text-gray-700 mb-4 leading-relaxed font-medium">
                {% blocktrans with email=request.session.unverified_email %}We have sent a verification email to <span class="font-semibold text-blue-600">{{ email }}</span>. 
                Please check your inbox and click the link to confirm your account.{% endblocktrans %}
            </p>
        {% elif user.is_authenticated %}
            <p class="text-gray-700 mb-4 leading-relaxed font-medium">
                {% blocktrans with email=user.email %}We have sent a verification email to <span class="font-semibold text-blue-600">{{ email }}</span>. 
                Please check your inbox and click the link to confirm your account.{% endblocktrans %}
            </p>
        {% else %}
            <p class="text-gray-700 mb-4 leading-relaxed font-medium">
                {% trans "Please enter your email address to resend the verification email." %}
            </p>
        {% endif %}

        <!-- Additional Instructions -->
        <p class="text-gray-600 mb-6 leading-relaxed text-sm">
            {% blocktrans %}If you don't see the email, check your spam or junk folder. 
            You can also request a new verification email below.{% endblocktrans %}
        </p>
        
        <!-- Smart Resend Verification Form -->
        {% if request.session.unverified_email %}
            <!-- Solution 3: Use session email (seamless) -->
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-700">
                    <strong>Verification email will be sent to:</strong> {{ request.session.unverified_email }}
                </p>
            </div>
            
            <form id="resend-form" method="post" action="{% url 'resend_verification' %}"
      data-cooldown-active="{{ cooldown_active|yesno:'true,false' }}"
      data-remaining-time="{{ remaining_time|default:0 }}"
      data-email-sent="{{ email_sent|yesno:'true,false' }}">
                {% csrf_token %}
                <input type="hidden" name="email" value="{{ request.session.unverified_email }}">
                <button type="submit" id="resend-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl text-lg font-semibold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    <span id="btn-text">{% trans "Resend Verification Email" %}</span>
                    <div id="loading-spinner" class="hidden ml-2">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </button>
            </form>

        {% elif user.is_authenticated %}
            <!-- User is logged in but no session email -->
            <form id="resend-form" method="post" action="{% url 'resend_verification' %}">
                {% csrf_token %}
                <input type="hidden" name="email" value="{{ user.email }}">
                <button type="submit" id="resend-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl text-lg font-semibold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    <span id="btn-text">{% trans "Resend Verification Email" %}</span>
                    <div id="loading-spinner" class="hidden ml-2">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </button>
            </form>

        {% endif %}

        <!-- Cooldown Notice (hidden by default) -->
        <div id="cooldown-notice" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm text-yellow-700">
                <strong>Please wait</strong> - You can request another email in <span id="cooldown-timer" class="font-bold">60</span> seconds.
            </p>
        </div>

        <!-- Back to Login -->
        <p class="mt-6 text-gray-500 text-sm">
            {% trans "Already verified?" %} 
            <a href="{% url 'account_login' %}" class="text-blue-600 hover:text-blue-700 font-semibold">
                {% trans "Sign in" %}
            </a>.
        </p>

    </div>
</div>

<script>
let cooldownActive = false;
let cooldownTime = 60;
let countdownInterval = null;

// Initialize on page load - check server state
document.addEventListener('DOMContentLoaded', function() {
    // Get server-side state from DOM data attributes instead of template variables
    const formElement = document.getElementById('resend-form');
    const serverCooldownActive = formElement ? formElement.dataset.cooldownActive === 'true' : false;
    const serverRemainingTime = formElement ? parseInt(formElement.dataset.remainingTime || '0') : 0;
    const emailJustSent = formElement ? formElement.dataset.emailSent === 'true' : false;
    const successMessages = document.querySelectorAll('.bg-green-100');
    
    // Determine initial state
    if (serverCooldownActive && serverRemainingTime > 0) {
        cooldownTime = serverRemainingTime;
        startCooldown();
    } else if (emailJustSent || successMessages.length > 0) {
        startCooldown();
    }
    
    setupMessageDismissal();
});

// Form submission handler
document.getElementById('resend-form').addEventListener('submit', function(e) {
    if (cooldownActive) {
        e.preventDefault();
        showMessage('Please wait before sending another email.', 'warning');
        return false;
    }
    
    showLoadingState();
});

function showLoadingState() {
    const submitBtn = document.getElementById('resend-btn');
    const btnText = document.getElementById('btn-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    
    submitBtn.disabled = true;
    btnText.textContent = 'Sending...';
    loadingSpinner.classList.remove('hidden');
    cooldownActive = true;
}

function startCooldown() {
    const submitBtn = document.getElementById('resend-btn');
    const btnText = document.getElementById('btn-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const cooldownNotice = document.getElementById('cooldown-notice');
    const cooldownTimer = document.getElementById('cooldown-timer');
    
    if (!submitBtn || !cooldownNotice) return;
    
    cooldownActive = true;
    
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    loadingSpinner.classList.add('hidden');
    btnText.textContent = 'Email Sent';
    submitBtn.disabled = true;
    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    submitBtn.classList.add('bg-green-600');
    
    cooldownNotice.classList.remove('hidden');
    
    let timeLeft = cooldownTime;
    cooldownTimer.textContent = timeLeft;
    
    countdownInterval = setInterval(function() {
        timeLeft--;
        cooldownTimer.textContent = timeLeft;
        
        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            resetButton();
        }
    }, 1000);
}

function resetButton() {
    const submitBtn = document.getElementById('resend-btn');
    const btnText = document.getElementById('btn-text');
    const cooldownNotice = document.getElementById('cooldown-notice');
    
    cooldownActive = false;
    cooldownTime = 60;
    
    if (cooldownNotice) cooldownNotice.classList.add('hidden');
    
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('bg-green-600');
        submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        btnText.textContent = 'Resend Verification Email';
    }
}

function setupMessageDismissal() {
    const messages = document.querySelectorAll('[class*="bg-red-100"], [class*="bg-green-100"], [class*="bg-blue-100"], [class*="bg-yellow-100"]');
    messages.forEach(function(message, index) {
        setTimeout(function() {
            if (message.parentElement) {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(function() { message.remove(); }, 300);
            }
        }, 5000 + (index * 500));
    });
}

function showMessage(text, type) {
    const messageDiv = document.createElement('div');
    const colorClasses = {
        'success': 'bg-green-100 border-green-300 text-green-700',
        'error': 'bg-red-100 border-red-300 text-red-700',
        'warning': 'bg-yellow-100 border-yellow-300 text-yellow-700'
    };
    
    messageDiv.className = 'mb-4 p-4 rounded-lg border ' + (colorClasses[type] || colorClasses.error);
    messageDiv.textContent = text;
    
    const container = document.querySelector('.bg-white.shadow-2xl');
    const title = container.querySelector('h1');
    container.insertBefore(messageDiv, title.nextSibling);
    
    setTimeout(function() {
        messageDiv.style.opacity = '0';
        setTimeout(function() { messageDiv.remove(); }, 300);
    }, 3000);
}

window.addEventListener('beforeunload', function() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
});
</script>
{% endblock content %}