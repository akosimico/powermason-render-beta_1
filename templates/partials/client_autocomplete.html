<!-- Client Autocomplete Component -->
<div class="client-selection-container">
  <label class="block text-sm font-medium text-gray-700 mb-1">Client *</label>

  <!-- Client Search Input -->
  <div class="relative">
    <input type="hidden" id="selectedClientId" name="client" value="">
    <input
      type="text"
      id="clientSearch"
      placeholder="Search for existing client or type new company name..."
      class="w-full px-3 py-2 border border-gray-300 rounded-md 
             focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      autocomplete="off"
    />

    <!-- Search Results Dropdown -->
    <div
      id="clientDropdown"
      class="absolute z-10 w-full mt-1 bg-white border border-gray-300 
             rounded-md shadow-lg hidden max-h-60 overflow-y-auto"
    >
      <div id="clientResults"></div>
      <div class="border-t border-gray-200 p-3">
        <button
          type="button"
          id="addNewClientBtn"
          class="w-full text-left text-blue-600 hover:text-blue-800 
                 text-sm font-medium"
        >
          + Add New Client
        </button>
      </div>
    </div>
  </div>

  <!-- Selected Client Display -->
  <div
    id="selectedClientInfo"
    class="hidden mt-2 p-3 bg-gray-50 rounded-md border"
  >
    <div class="flex justify-between items-start">
      <div>
        <h4 class="font-medium text-gray-900" id="selectedCompanyName"></h4>
        <p class="text-sm text-gray-600" id="selectedContactName"></p>
        <p class="text-sm text-gray-500" id="selectedClientDetails"></p>
      </div>
      <button
        type="button"
        onclick="clearClientSelection()"
        class="text-gray-400 hover:text-gray-600"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
                stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Quick Add Client Modal -->
<div
  id="quickClientModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"
  >
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">Quick Add Client</h3>
        <button onclick="closeQuickClientModal()" class="text-gray-400 hover:text-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- No <form>, just a div -->
      <div id="quickClientForm">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
            <input
              type="text"
              id="quickCompanyName"
              class="w-full px-3 py-2 border border-gray-300 rounded-md 
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name *</label>
            <input
              type="text"
              id="quickContactName"
              class="w-full px-3 py-2 border border-gray-300 rounded-md 
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              id="quickEmail"
              class="w-full px-3 py-2 border border-gray-300 rounded-md 
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
            <input
              type="tel"
              id="quickPhone"
              class="w-full px-3 py-2 border border-gray-300 rounded-md 
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>

        <div
          class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200"
        >
          <button
            type="button"
            onclick="closeQuickClientModal()"
            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition"
          >
            Cancel
          </button>
          <button
            type="button"
            id="quickClientSubmit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
          >
            Add & Select
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// --- Same JS as before, just adapted for no <form> ---
let searchTimeout, selectedClient = null;

document.getElementById('clientSearch').addEventListener('input', function(e) {
  const query = e.target.value.trim();
  clearTimeout(searchTimeout);
  if (query.length < 2) { hideClientDropdown(); return; }
  searchTimeout = setTimeout(() => { searchClients(query); }, 300);
});

function searchClients(query) {
  fetch(`/manage-client/api/clients/search/?q=${encodeURIComponent(query)}`)
    .then(r => r.json())
    .then(data => displayClientResults(data.clients))
    .catch(err => console.error('Error searching clients:', err));
}

function displayClientResults(clients) {
  const results = document.getElementById('clientResults');
  const dropdown = document.getElementById('clientDropdown');
  results.innerHTML = clients.length
    ? clients.map(c => `
        <div class="client-option p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100" 
             onclick="selectClient(${JSON.stringify(c).replace(/"/g, '&quot;')})">
          <div class="font-medium text-gray-900">${c.company_name}</div>
          <div class="text-sm text-gray-600">${c.contact_name}</div>
          ${c.email ? `<div class="text-xs text-gray-500">${c.email}</div>` : ''}
        </div>`).join('')
    : '<div class="p-3 text-gray-500 text-sm">No clients found</div>';
  dropdown.classList.remove('hidden');
}

function selectClient(client) {
  selectedClient = client;
  document.getElementById('selectedClientId').value = client.id;
  document.getElementById('clientSearch').value = client.company_name;
  document.getElementById('selectedCompanyName').textContent = client.company_name;
  document.getElementById('selectedContactName').textContent = client.contact_name;
  document.getElementById('selectedClientDetails').textContent =
    [client.email, client.phone].filter(Boolean).join(' â€¢ ');
  document.getElementById('selectedClientInfo').classList.remove('hidden');
  hideClientDropdown();
}

function clearClientSelection() {
  selectedClient = null;
  document.getElementById('selectedClientId').value = '';
  document.getElementById('clientSearch').value = '';
  document.getElementById('selectedClientInfo').classList.add('hidden');
}

function hideClientDropdown() {
  document.getElementById('clientDropdown').classList.add('hidden');
}

document.getElementById('addNewClientBtn').addEventListener('click', () => {
  const searchValue = document.getElementById('clientSearch').value.trim();
  if (searchValue) document.getElementById('quickCompanyName').value = searchValue;
  document.getElementById('quickClientModal').classList.remove('hidden');
  hideClientDropdown();
});

document.getElementById('quickClientSubmit').addEventListener('click', () => {
  const formData = new FormData();
  formData.append('company_name', document.getElementById('quickCompanyName').value);
  formData.append('contact_name', document.getElementById('quickContactName').value);
  formData.append('email', document.getElementById('quickEmail').value);
  formData.append('phone', document.getElementById('quickPhone').value);
  formData.append('is_active', 'on');
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
  formData.append('csrfmiddlewaretoken', csrf);

  fetch('/manage-client/clients/add/', { method: 'POST', body: formData })
    .then(r => r.ok ? fetch(`/manage-client/api/clients/search/?q=${encodeURIComponent(document.getElementById('quickCompanyName').value)}`) : Promise.reject())
    .then(r => r.json())
    .then(data => {
      const newClient = data.clients.find(c =>
        c.company_name.toLowerCase() === document.getElementById('quickCompanyName').value.toLowerCase()
      );
      if (newClient) {
        selectClient(newClient);
        closeQuickClientModal();
        showNotification('Client added successfully!', 'success');
      }
    })
    .catch(err => {
      console.error('Error adding client:', err);
      showNotification('Error adding client. Please try again.', 'error');
    });
});

function closeQuickClientModal() {
  document.getElementById('quickClientModal').classList.add('hidden');
  document.querySelectorAll('#quickClientForm input').forEach(el => el.value = '');
}

document.addEventListener('click', e => {
  if (!e.target.closest('.client-selection-container')) hideClientDropdown();
});

function showNotification(message, type = 'info') {
  const n = document.createElement('div');
  n.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${
    type === 'success' ? 'bg-green-100 text-green-700' :
    type === 'error'   ? 'bg-red-100 text-red-700'   : 'bg-blue-100 text-blue-700'
  }`;
  n.textContent = message;
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 3000);
}

// Pre-populate if editing existing project
document.addEventListener('DOMContentLoaded', () => {
  const preSelectedClientId = document.getElementById('selectedClientId').value;
  if (preSelectedClientId) {
    fetch(`/manage-client/api/clients/${preSelectedClientId}/`)
      .then(r => r.json())
      .then(client => selectClient(client))
      .catch(err => console.error('Error loading pre-selected client:', err));
  }
});
</script>

<style>
.client-option:last-child { border-bottom: none; }
.client-selection-container .relative { position: relative; }
#clientDropdown { min-width: 100%; }
</style>
