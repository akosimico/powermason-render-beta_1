<!-- Add/Edit Modal -->
<div id="projectTypeModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto">
    <!-- Close button -->
    <button type="button" id="modalCloseBtn" 
  class="modalClose absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
  ✕
</button>


    <!-- Title -->
    <h2 id="modalTitle" class="text-2xl font-semibold text-gray-800 mb-6">Add Project Type</h2>

    <!-- Form -->
    <form id="modalForm" method="POST" class="space-y-5">
      {% csrf_token %}
      <input type="hidden" id="projectTypeId" name="project_type_id" value="">
      
      <!-- Name -->
      <div>
        <label for="id_name" class="block text-sm font-medium text-gray-700">Name</label>
        <input type="text" name="name" id="id_name" 
          class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 placeholder-gray-400 sm:text-sm" 
          placeholder="Enter project type name" required>
      </div>

      <!-- Code -->
      <div>
        <label for="id_code" class="block text-sm font-medium text-gray-700">Code</label>
        <input type="text" name="code" id="id_code" 
          class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 placeholder-gray-400 sm:text-sm" 
          placeholder="Unique code" required>
      </div>

      <!-- Description -->
      <div>
        <label for="id_description" class="block text-sm font-medium text-gray-700">Description</label>
        <textarea name="description" id="id_description" rows="3" 
          class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 placeholder-gray-400 sm:text-sm"
          placeholder="Add a short description..."></textarea>
      </div>

      <!-- Active checkbox -->
      <div class="flex items-center space-x-2">
        <input type="checkbox" name="is_active" id="id_is_active" 
          class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
        <label for="id_is_active" class="text-sm text-gray-700">Active</label>
      </div>

          <!-- BOQ Upload Section -->
          <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
              </svg>
              Upload BOQ to Build Cost Database
            </h3>
            <p class="text-sm text-gray-600 mb-4">
              Upload BOQ documents to automatically learn typical costs for this project type. The system will extract cost data and use it for future cost estimations.
            </p>

            <!-- File Upload Zone -->
            <div id="boqUploadZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer" onclick="document.getElementById('boqFileInput').click()">
              <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 1.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <p class="text-base font-semibold text-gray-700 mb-1">Click to upload BOQ files</p>
              <p class="text-sm text-gray-500">PDF, XLS, XLSX files (Max 10MB)</p>
              <p class="text-xs text-gray-400 mt-2">Use the standard BOQ template for best results</p>
            </div>

            <!-- Hidden file input -->
            <input type="file" id="boqFileInput" class="hidden" accept=".pdf,.xls,.xlsx" multiple onchange="handleBOQUpload(event)">

            <!-- Uploaded BOQ Files List -->
            <div id="uploadedBOQList" class="mt-4 space-y-2 hidden">
              <h5 class="text-sm font-medium text-gray-700">Uploaded BOQ Files:</h5>
              <div id="boqFilesList" class="space-y-2"></div>
            </div>

            <!-- Download Template Link -->
            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
              <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <a href="/static/templates/BOQ_Template_Instructions.txt" download class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                  Download BOQ Template Instructions
                </a>
              </div>
              <p class="text-xs text-gray-600 mt-1">Follow the template structure for automatic cost extraction</p>
            </div>
          </div>

          <!-- Cost Configuration Section -->
          <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
              </svg>
              Manual Cost Configuration (Optional)
            </h3>
            <p class="text-sm text-gray-600 mb-4">
              Manually configure base costs if you prefer not to use learned data from BOQ uploads.
            </p>
            
            <!-- Auto-configure button -->
            <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
              <div class="flex items-center justify-between">
                <div>
                  <h4 class="text-sm font-medium text-blue-900">Auto-Configure from BOQ Data</h4>
                  <p class="text-xs text-blue-700 mt-1">Automatically set costs based on approved BOQ data from similar projects</p>
                </div>
                <button type="button" id="autoConfigureBtn" 
                        class="px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-400 focus:outline-none transition">
                  Auto-Configure
                </button>
              </div>
            </div>
        <p class="text-sm text-gray-600 mb-4">
          Configure base costs per square meter for different complexity levels. These will be used for automatic cost estimation.
        </p>

        <!-- Base Costs -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Low End Cost -->
          <div>
            <label for="id_base_cost_low_end" class="block text-sm font-medium text-gray-700 mb-1">
              Low End Cost (₱/sqm)
            </label>
            <div class="relative">
              <input type="number" name="base_cost_low_end" id="id_base_cost_low_end" 
                step="0.01" min="0" placeholder="0.00"
                class="block w-full px-3 py-2 pr-8 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <span class="text-gray-500 sm:text-sm">₱</span>
              </div>
            </div>
            <p class="mt-1 text-xs text-gray-500">Basic projects with standard finishes</p>
          </div>

          <!-- Mid Range Cost -->
          <div>
            <label for="id_base_cost_mid_range" class="block text-sm font-medium text-gray-700 mb-1">
              Mid Range Cost (₱/sqm)
            </label>
            <div class="relative">
              <input type="number" name="base_cost_mid_range" id="id_base_cost_mid_range" 
                step="0.01" min="0" placeholder="0.00"
                class="block w-full px-3 py-2 pr-8 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <span class="text-gray-500 sm:text-sm">₱</span>
              </div>
            </div>
            <p class="mt-1 text-xs text-gray-500">Standard projects with good quality</p>
          </div>

          <!-- High End Cost -->
          <div>
            <label for="id_base_cost_high_end" class="block text-sm font-medium text-gray-700 mb-1">
              High End Cost (₱/sqm)
            </label>
            <div class="relative">
              <input type="number" name="base_cost_high_end" id="id_base_cost_high_end" 
                step="0.01" min="0" placeholder="0.00"
                class="block w-full px-3 py-2 pr-8 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <span class="text-gray-500 sm:text-sm">₱</span>
              </div>
            </div>
            <p class="mt-1 text-xs text-gray-500">Premium projects with luxury finishes</p>
          </div>
        </div>

        <!-- Cost Breakdown Percentages -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="text-md font-medium text-gray-900 mb-3">Cost Breakdown Percentages</h4>
          <p class="text-sm text-gray-600 mb-4">
            Define how the total project cost is distributed across different categories. Percentages must add up to 100%.
          </p>
          
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <!-- Materials -->
            <div>
              <label for="id_materials_percentage" class="block text-sm font-medium text-gray-700 mb-1">
                Materials (%)
              </label>
              <input type="number" name="materials_percentage" id="id_materials_percentage" 
                step="0.01" min="0" max="100" value="40.00" placeholder="40.00"
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Labor -->
            <div>
              <label for="id_labor_percentage" class="block text-sm font-medium text-gray-700 mb-1">
                Labor (%)
              </label>
              <input type="number" name="labor_percentage" id="id_labor_percentage" 
                step="0.01" min="0" max="100" value="30.00" placeholder="30.00"
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Equipment -->
            <div>
              <label for="id_equipment_percentage" class="block text-sm font-medium text-gray-700 mb-1">
                Equipment (%)
              </label>
              <input type="number" name="equipment_percentage" id="id_equipment_percentage" 
                step="0.01" min="0" max="100" value="10.00" placeholder="10.00"
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Permits -->
            <div>
              <label for="id_permits_percentage" class="block text-sm font-medium text-gray-700 mb-1">
                Permits (%)
              </label>
              <input type="number" name="permits_percentage" id="id_permits_percentage" 
                step="0.01" min="0" max="100" value="5.00" placeholder="5.00"
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Contingency -->
            <div>
              <label for="id_contingency_percentage" class="block text-sm font-medium text-gray-700 mb-1">
                Contingency (%)
              </label>
              <input type="number" name="contingency_percentage" id="id_contingency_percentage" 
                step="0.01" min="0" max="100" value="10.00" placeholder="10.00"
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Overhead -->
            <div>
              <label for="id_overhead_percentage" class="block text-sm font-medium text-gray-700 mb-1">
                Overhead (%)
              </label>
              <input type="number" name="overhead_percentage" id="id_overhead_percentage" 
                step="0.01" min="0" max="100" value="5.00" placeholder="5.00"
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>

          <!-- Total Percentage Display -->
          <div class="mt-4 p-3 bg-blue-50 rounded-md">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-blue-900">Total Percentage:</span>
              <span id="totalPercentage" class="text-sm font-bold text-blue-900">100%</span>
            </div>
            <div class="mt-2">
              <div class="w-full bg-blue-200 rounded-full h-2">
                <div id="percentageBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
        <button type="button" id="modalCancelBtn" 
          class="modalClose px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 focus:ring-2 focus:ring-gray-400 focus:outline-none">
          Cancel
        </button>
        <button type="submit" id="modalSubmitBtn" 
          class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-400 focus:outline-none">
          Create
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Calculate and display total percentage in modal
function updateModalTotalPercentage() {
    const percentageFields = [
        'materials_percentage', 'labor_percentage', 'equipment_percentage',
        'permits_percentage', 'contingency_percentage', 'overhead_percentage'
    ];
    
    let total = 0;
    percentageFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value) {
            total += parseFloat(field.value) || 0;
        }
    });
    
    const totalElement = document.getElementById('totalPercentage');
    const barElement = document.getElementById('percentageBar');
    
    if (totalElement && barElement) {
        totalElement.textContent = total.toFixed(2) + '%';
        barElement.style.width = Math.min(total, 100) + '%';
        
        // Change color based on total
        if (Math.abs(total - 100) < 0.01) {
            barElement.className = 'bg-green-600 h-2 rounded-full transition-all duration-300';
            totalElement.className = 'text-sm font-bold text-green-900';
        } else if (total > 100) {
            barElement.className = 'bg-red-600 h-2 rounded-full transition-all duration-300';
            totalElement.className = 'text-sm font-bold text-red-900';
        } else {
            barElement.className = 'bg-blue-600 h-2 rounded-full transition-all duration-300';
            totalElement.className = 'text-sm font-bold text-blue-900';
        }
    }
}

// Add event listeners to percentage fields in modal
document.addEventListener('DOMContentLoaded', function() {
    const percentageFields = [
        'materials_percentage', 'labor_percentage', 'equipment_percentage',
        'permits_percentage', 'contingency_percentage', 'overhead_percentage'
    ];
    
    percentageFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updateModalTotalPercentage);
        }
    });
    
       // Initial calculation
       updateModalTotalPercentage();
   });

   // Store extracted data for preview
   const extractedDataStore = {};

   // BOQ Upload Functions
   function handleBOQUpload(event) {
       const files = event.target.files;
       if (!files || files.length === 0) return;

       for (let file of files) {
           // Validate file type
           const allowedTypes = ['.pdf', '.xls', '.xlsx'];
           const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

           if (!allowedTypes.includes(fileExtension)) {
               alert(`File ${file.name} is not supported. Please select PDF or Excel files.`);
               continue;
           }

           // Validate file size (10MB limit)
           if (file.size > 10 * 1024 * 1024) {
               alert(`File ${file.name} is too large. Maximum size is 10MB.`);
               continue;
           }

           // Show file in uploaded files list
           showUploadedBOQFile(file);
           
           // Process file for cost extraction
           processBOQFile(file);
       }
   }

   function showUploadedBOQFile(file) {
       const uploadedBOQList = document.getElementById('uploadedBOQList');
       const boqFilesList = document.getElementById('boqFilesList');

       const fileItem = document.createElement('div');
       fileItem.className = 'flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg';
       fileItem.innerHTML = `
           <div class="flex items-center">
               <svg class="w-8 h-8 text-blue-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                   <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
               </svg>
               <div>
                   <p class="text-sm font-medium text-gray-900">${file.name}</p>
                   <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
               </div>
           </div>
           <div class="flex items-center space-x-2">
               <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                   Processing...
               </span>
               <button onclick="previewBOQData('${file.name}')" class="text-blue-500 hover:text-blue-700" title="Preview extracted data">
                   <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                       <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                       <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                   </svg>
               </button>
               <button onclick="removeUploadedBOQFile(this)" class="text-red-500 hover:text-red-700" title="Remove file">
                   <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                       <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                   </svg>
               </button>
           </div>
       `;

       boqFilesList.appendChild(fileItem);
       uploadedBOQList.classList.remove('hidden');
   }

   function removeUploadedBOQFile(button) {
       const fileItem = button.closest('.flex');
       if (fileItem) {
           // Get the file name to clean up stored data
           const nameElement = fileItem.querySelector('p.text-sm.font-medium');
           if (nameElement) {
               const fileName = nameElement.textContent;
               delete extractedDataStore[fileName];
           }
           
           fileItem.remove();
       }
       
       const boqFilesList = document.getElementById('boqFilesList');
       if (boqFilesList && boqFilesList.children.length === 0) {
           document.getElementById('uploadedBOQList').classList.add('hidden');
       }
   }

   function formatFileSize(bytes) {
       if (bytes === 0) return '0 Bytes';
       const k = 1024;
       const sizes = ['Bytes', 'KB', 'MB', 'GB'];
       const i = Math.floor(Math.log(bytes) / Math.log(k));
       return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
   }

   async function processBOQFile(file) {
       try {
           const formData = new FormData();
           formData.append('file', file);
           // Get project type ID from the form or modal context
           const projectTypeId = document.getElementById('projectTypeId')?.value || 
                                 document.querySelector('input[name="project_type_id"]')?.value || 
                                 '';
           
           // If no project type ID, we can still process the file for preview
           if (projectTypeId) {
               formData.append('project_type_id', projectTypeId);
           }

           const response = await fetch('/projects/api/boq-upload/', {
               method: 'POST',
               headers: {
                   'X-CSRFToken': getCookie('csrftoken')
               },
               body: formData
           });

           const result = await response.json();

           if (result.success) {
               // Store extracted data for preview
               extractedDataStore[file.name] = result.cost_data;
               
               // Update file status to success - find the file item by file name
               const fileName = file.name;
               const fileItems = document.querySelectorAll('#boqFilesList .flex');
               for (let fileItem of fileItems) {
                   const nameElement = fileItem.querySelector('p.text-sm.font-medium');
                   if (nameElement && nameElement.textContent === fileName) {
                       const statusSpan = fileItem.querySelector('.inline-flex');
                       if (statusSpan) {
                           statusSpan.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                           statusSpan.textContent = 'Processed';
                       }
                       break;
                   }
               }
               
               // Show success message
               showToast('BOQ file processed successfully! Cost data extracted.', 'success');
           } else {
               // Update file status to error - find the file item by file name
               const fileName = file.name;
               const fileItems = document.querySelectorAll('#boqFilesList .flex');
               for (let fileItem of fileItems) {
                   const nameElement = fileItem.querySelector('p.text-sm.font-medium');
                   if (nameElement && nameElement.textContent === fileName) {
                       const statusSpan = fileItem.querySelector('.inline-flex');
                       if (statusSpan) {
                           statusSpan.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                           statusSpan.textContent = 'Error';
                       }
                       break;
                   }
               }
               
               showToast('Error processing BOQ file: ' + result.error, 'error');
           }
       } catch (error) {
           showToast('Network error: ' + error.message, 'error');
       }
   }

   function showToast(message, type = 'info') {
       // Simple toast notification
       const toast = document.createElement('div');
       toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
           type === 'success' ? 'bg-green-500 text-white' : 
           type === 'error' ? 'bg-red-500 text-white' : 
           'bg-blue-500 text-white'
       }`;
       toast.textContent = message;
       
       document.body.appendChild(toast);
       
       setTimeout(() => {
           toast.remove();
       }, 5000);
   }

   function getCookie(name) {
       let cookieValue = null;
       if (document.cookie && document.cookie !== '') {
           const cookies = document.cookie.split(';');
           for (let i = 0; i < cookies.length; i++) {
               const cookie = cookies[i].trim();
               if (cookie.substring(0, name.length + 1) === (name + '=')) {
                   cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                   break;
               }
           }
       }
       return cookieValue;
   }

   // Preview BOQ Data Function
   function previewBOQData(fileName, mode = 'basic') {
       const data = extractedDataStore[fileName];
       if (!data) {
           showToast('No data available for preview. Please process the file first.', 'error');
           return;
       }

       // Create preview modal
       const previewModal = document.createElement('div');
       previewModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
       
       // Determine modal size based on mode
       const modalSize = mode === 'detailed' ? 'max-w-6xl' : 'max-w-2xl';
       
       previewModal.innerHTML = `
           <div class="bg-white rounded-2xl shadow-2xl w-full ${modalSize} p-6 relative max-h-[90vh] overflow-y-auto">
               <div class="flex justify-between items-center mb-6">
                   <h3 class="text-xl font-semibold text-gray-900">BOQ Data Preview - ${mode === 'detailed' ? 'Detailed' : 'Basic'} Mode</h3>
                   <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                       <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                       </svg>
                   </button>
               </div>
               
               <div class="space-y-4">
                   <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                       <h4 class="text-lg font-medium text-blue-900 mb-3">File: ${fileName}</h4>
                       ${data.project_info ? `
                           <div class="grid grid-cols-2 gap-4 text-sm">
                               <div><strong>Project:</strong> ${data.project_info.project_name || 'N/A'}</div>
                               <div><strong>Type:</strong> ${data.project_info.project_type || 'N/A'}</div>
                               <div><strong>Location:</strong> ${data.project_info.location || 'N/A'}</div>
                               <div><strong>Role:</strong> ${data.project_info.role || 'General Contractor'}</div>
                           </div>
                       ` : ''}
                   </div>
                   
                   ${mode === 'basic' ? getBasicPreviewHTML(data) : getDetailedPreviewHTML(data)}
                   
                   <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                       <div class="flex items-center">
                           <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                               <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                           </svg>
                           <span class="text-green-800 font-medium">Data successfully extracted and ready for ${mode === 'detailed' ? 'project creation' : 'cost learning'}!</span>
                       </div>
                   </div>
               </div>
               
               <div class="flex justify-end mt-6">
                   <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                       Close
                   </button>
               </div>
           </div>
       `;
       
       document.body.appendChild(previewModal);
   }

   // Basic preview HTML (for project type management)
   function getBasicPreviewHTML(data) {
       return `
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
               <div class="bg-gray-50 rounded-lg p-4">
                   <h5 class="font-medium text-gray-900 mb-2">Project Summary</h5>
                   <div class="space-y-2 text-sm">
                       <div class="flex justify-between">
                           <span class="text-gray-600">Total Cost:</span>
                           <span class="font-medium">₱${parseFloat(data.total_cost || 0).toLocaleString()}</span>
                       </div>
                       <div class="flex justify-between">
                           <span class="text-gray-600">Lot Size:</span>
                           <span class="font-medium">${parseFloat(data.lot_size || 0).toLocaleString()} sqm</span>
                       </div>
                       <div class="flex justify-between">
                           <span class="text-gray-600">Floor Area:</span>
                           <span class="font-medium">${parseFloat(data.floor_area || 0).toLocaleString()} sqm</span>
                       </div>
                       <div class="flex justify-between">
                           <span class="text-gray-600">Cost per sqm:</span>
                           <span class="font-medium text-blue-600">₱${parseFloat(data.cost_per_sqm || 0).toLocaleString()}</span>
                       </div>
                       ${data.project_type ? `
                       <div class="flex justify-between">
                           <span class="text-gray-600">Project Type:</span>
                           <span class="font-medium">${data.project_type}</span>
                       </div>
                       ` : ''}
                       ${data.complexity_level ? `
                       <div class="flex justify-between">
                           <span class="text-gray-600">Complexity:</span>
                           <span class="font-medium">${data.complexity_level}</span>
                       </div>
                       ` : ''}
                   </div>
               </div>
               
               <div class="bg-gray-50 rounded-lg p-4">
                   <h5 class="font-medium text-gray-900 mb-2">Cost Breakdown</h5>
                   <div class="space-y-2 text-sm">
                       <div class="flex justify-between">
                           <span class="text-gray-600">Materials:</span>
                           <span class="font-medium">₱${parseFloat(data.materials_cost || 0).toLocaleString()}</span>
                       </div>
                       <div class="flex justify-between">
                           <span class="text-gray-600">Labor:</span>
                           <span class="font-medium">₱${parseFloat(data.labor_cost || 0).toLocaleString()}</span>
                       </div>
                       <div class="flex justify-between">
                           <span class="text-gray-600">Equipment:</span>
                           <span class="font-medium">₱${parseFloat(data.equipment_cost || 0).toLocaleString()}</span>
                       </div>
                       <div class="flex justify-between">
                           <span class="text-gray-600">Subcontractor:</span>
                           <span class="font-medium">₱${parseFloat(data.subcontractor_cost || 0).toLocaleString()}</span>
                       </div>
                   </div>
               </div>
           </div>
       `;
   }

   // Detailed preview HTML (for project creation)
   function getDetailedPreviewHTML(data) {
       const boqItems = data.boq_items || [];
       
       return `
           <div class="space-y-4">
               <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                   <div class="bg-gray-50 rounded-lg p-4">
                       <h5 class="font-medium text-gray-900 mb-2">Project Summary</h5>
                       <div class="space-y-2 text-sm">
                           <div class="flex justify-between">
                               <span class="text-gray-600">Total Cost:</span>
                               <span class="font-medium">₱${parseFloat(data.total_cost || 0).toLocaleString()}</span>
                           </div>
                           <div class="flex justify-between">
                               <span class="text-gray-600">Lot Size:</span>
                               <span class="font-medium">${parseFloat(data.lot_size || 0).toLocaleString()} sqm</span>
                           </div>
                           <div class="flex justify-between">
                               <span class="text-gray-600">Floor Area:</span>
                               <span class="font-medium">${parseFloat(data.floor_area || 0).toLocaleString()} sqm</span>
                           </div>
                           <div class="flex justify-between">
                               <span class="text-gray-600">Cost per sqm:</span>
                               <span class="font-medium text-blue-600">₱${parseFloat(data.cost_per_sqm || 0).toLocaleString()}</span>
                           </div>
                           <div class="flex justify-between">
                               <span class="text-gray-600">Total Items:</span>
                               <span class="font-medium">${boqItems.length}</span>
                           </div>
                           ${data.project_type ? `
                           <div class="flex justify-between">
                               <span class="text-gray-600">Project Type:</span>
                               <span class="font-medium">${data.project_type}</span>
                           </div>
                           ` : ''}
                           ${data.complexity_level ? `
                           <div class="flex justify-between">
                               <span class="text-gray-600">Complexity:</span>
                               <span class="font-medium">${data.complexity_level}</span>
                           </div>
                           ` : ''}
                       </div>
                   </div>
                   
                   <div class="bg-gray-50 rounded-lg p-4">
                       <h5 class="font-medium text-gray-900 mb-2">Cost Breakdown</h5>
                       <div class="space-y-2 text-sm">
                           <div class="flex justify-between">
                               <span class="text-gray-600">Materials:</span>
                               <span class="font-medium">₱${parseFloat(data.materials_cost || 0).toLocaleString()}</span>
                           </div>
                           <div class="flex justify-between">
                               <span class="text-gray-600">Labor:</span>
                               <span class="font-medium">₱${parseFloat(data.labor_cost || 0).toLocaleString()}</span>
                           </div>
                           <div class="flex justify-between">
                               <span class="text-gray-600">Equipment:</span>
                               <span class="font-medium">₱${parseFloat(data.equipment_cost || 0).toLocaleString()}</span>
                           </div>
                           <div class="flex justify-between">
                               <span class="text-gray-600">Subcontractor:</span>
                               <span class="font-medium">₱${parseFloat(data.subcontractor_cost || 0).toLocaleString()}</span>
                           </div>
                       </div>
                   </div>
               </div>
               
               ${boqItems.length > 0 ? `
                   <div class="bg-white border border-gray-200 rounded-lg p-4">
                       <h5 class="font-medium text-gray-900 mb-3">BOQ Items (${boqItems.length} items)</h5>
                       <div class="overflow-x-auto">
                           <table class="min-w-full text-sm">
                               <thead class="bg-gray-50">
                                   <tr>
                                       <th class="px-3 py-2 text-left">Item</th>
                                       <th class="px-3 py-2 text-left">Description</th>
                                       <th class="px-3 py-2 text-left">Section</th>
                                       <th class="px-3 py-2 text-right">Qty</th>
                                       <th class="px-3 py-2 text-right">Unit Cost</th>
                                       <th class="px-3 py-2 text-right">Total</th>
                                       <th class="px-3 py-2 text-left">Dependencies</th>
                                   </tr>
                               </thead>
                               <tbody class="divide-y divide-gray-200">
                                   ${boqItems.slice(0, 10).map(item => `
                                       <tr>
                                           <td class="px-3 py-2 font-medium">${item.item_number || ''}</td>
                                           <td class="px-3 py-2">${item.description || ''}</td>
                                           <td class="px-3 py-2">${item.section || ''}</td>
                                           <td class="px-3 py-2 text-right">${parseFloat(item.quantity || 0).toLocaleString()}</td>
                                           <td class="px-3 py-2 text-right">₱${parseFloat(item.unit_cost || 0).toLocaleString()}</td>
                                           <td class="px-3 py-2 text-right font-medium">₱${parseFloat(item.total_cost || 0).toLocaleString()}</td>
                                           <td class="px-3 py-2">${item.dependencies ? item.dependencies.join(', ') : ''}</td>
                                       </tr>
                                   `).join('')}
                                   ${boqItems.length > 10 ? `
                                       <tr>
                                           <td colspan="7" class="px-3 py-2 text-center text-gray-500">
                                               ... and ${boqItems.length - 10} more items
                                           </td>
                                       </tr>
                                   ` : ''}
                               </tbody>
                           </table>
                       </div>
                   </div>
               ` : ''}
           </div>
       `;
   }
   </script>

<!-- Delete Modal -->
<div id="deleteModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
    <!-- Close button -->
    <button type="button" id="modalCloseBtn" 
  class="modalClose absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
  ✕
</button>


    <!-- Title -->
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Delete Project Type</h2>
    <p id="deleteText" class="text-gray-600 mb-6">Are you sure you want to delete this project type?</p>

    <!-- Actions -->
    <form id="deleteForm" method="POST" class="flex justify-end space-x-3 border-t border-gray-200 pt-4">
      {% csrf_token %}
      <button type="button" class="modalClose px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 focus:ring-2 focus:ring-gray-400 focus:outline-none">
        Cancel
      </button>
      <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-400 focus:outline-none">
        Delete
      </button>
    </form>
  </div>
</div>
