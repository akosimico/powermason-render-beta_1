{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Mobilization Costs</h1>
            <button onclick="openAddMobilizationModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Mobilization Cost
            </button>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Project</label>
                <select id="projectFilter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Projects</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category</label>
                <select id="categoryFilter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Categories</option>
                    <option value="EQUIP">Equipment</option>
                    <option value="TRANS">Transportation</option>
                    <option value="LABOR">Labor</option>
                    <option value="MATER">Materials</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" id="searchInput" placeholder="Search description..." class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 rounded-lg p-4">
                <div class="text-sm text-blue-600 font-medium">Total Costs</div>
                <div class="text-2xl font-bold text-blue-900" id="totalCosts">₱0.00</div>
            </div>
            <div class="bg-green-50 rounded-lg p-4">
                <div class="text-sm text-green-600 font-medium">Equipment</div>
                <div class="text-2xl font-bold text-green-900" id="equipmentCosts">₱0.00</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-4">
                <div class="text-sm text-purple-600 font-medium">Transportation</div>
                <div class="text-2xl font-bold text-purple-900" id="transportCosts">₱0.00</div>
            </div>
            <div class="bg-orange-50 rounded-lg p-4">
                <div class="text-sm text-orange-600 font-medium">Labor</div>
                <div class="text-2xl font-bold text-orange-900" id="laborCosts">₱0.00</div>
            </div>
        </div>

        <!-- Table -->
        <div class="border border-gray-200 rounded-xl shadow overflow-x-auto">
            <table class="w-full table-auto text-sm">
                <thead class="bg-gray-50 text-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium">Project</th>
                        <th class="px-4 py-3 text-left font-medium">Category</th>
                        <th class="px-4 py-3 text-left font-medium">Description</th>
                        <th class="px-4 py-3 text-right font-medium">Amount</th>
                        <th class="px-4 py-3 text-center font-medium">Date</th>
                        <th class="px-4 py-3 text-center font-medium">Actions</th>
                    </tr>
                </thead>
                <tbody id="mobilizationTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <div class="flex flex-col items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p>Loading mobilization costs...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Mobilization Cost Modal -->
<div id="mobilizationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900" id="modalTitle">Add Mobilization Cost</h3>
            <button onclick="closeMobilizationModal()" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="mobilizationForm" onsubmit="submitMobilizationForm(event)">
            <input type="hidden" id="costId" name="cost_id">

            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Project *</label>
                    <select id="projectSelect" name="project" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Project</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                    <select id="categorySelect" name="category" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Category</option>
                        <option value="EQUIP">Equipment</option>
                        <option value="TRANS">Transportation</option>
                        <option value="LABOR">Labor</option>
                        <option value="MATER">Materials</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                    <textarea id="descriptionInput" name="description" rows="3" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Describe the mobilization cost..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount *</label>
                    <input type="number" id="amountInput" name="amount" step="0.01" min="0" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Incurred *</label>
                    <input type="date" id="dateInput" name="date_incurred" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="notesInput" name="notes" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Additional notes..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeMobilizationModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Save Cost
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let allCosts = [];
let allProjects = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
    loadMobilizationCosts();

    // Setup filter listeners
    document.getElementById('projectFilter').addEventListener('change', filterCosts);
    document.getElementById('categoryFilter').addEventListener('change', filterCosts);
    document.getElementById('searchInput').addEventListener('input', filterCosts);
});

// Load projects for dropdowns
function loadProjects() {
    fetch('/projects/api/project-list/')
        .then(response => response.json())
        .then(data => {
            allProjects = data.projects || [];
            const projectFilter = document.getElementById('projectFilter');
            const projectSelect = document.getElementById('projectSelect');

            allProjects.forEach(project => {
                // Add to filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = project.id;
                filterOption.textContent = `${project.project_id} - ${project.project_name}`;
                projectFilter.appendChild(filterOption);

                // Add to form dropdown
                const selectOption = document.createElement('option');
                selectOption.value = project.id;
                selectOption.textContent = `${project.project_id} - ${project.project_name}`;
                projectSelect.appendChild(selectOption);
            });
        })
        .catch(error => {
            console.error('Error loading projects:', error);
        });
}

// Load mobilization costs
function loadMobilizationCosts() {
    fetch('/projects/api/mobilization-costs/')
        .then(response => response.json())
        .then(data => {
            allCosts = data.costs || [];
            updateSummaryCards(data.summary || {});
            displayCosts(allCosts);
        })
        .catch(error => {
            console.error('Error loading mobilization costs:', error);
            document.getElementById('mobilizationTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-8 text-red-500">
                        Error loading mobilization costs. Please try again.
                    </td>
                </tr>
            `;
        });
}

// Update summary cards
function updateSummaryCards(summary) {
    document.getElementById('totalCosts').textContent = formatCurrency(summary.total || 0);
    document.getElementById('equipmentCosts').textContent = formatCurrency(summary.equipment || 0);
    document.getElementById('transportCosts').textContent = formatCurrency(summary.transportation || 0);
    document.getElementById('laborCosts').textContent = formatCurrency(summary.labor || 0);
}

// Display costs in table
function displayCosts(costs) {
    const tbody = document.getElementById('mobilizationTableBody');

    if (costs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                        <p>No mobilization costs found. Click "Add Mobilization Cost" to get started.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = costs.map(cost => `
        <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-3 text-gray-900">
                <div class="font-medium">${cost.project_name}</div>
                <div class="text-xs text-gray-500">${cost.project_id}</div>
            </td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 text-xs font-medium rounded-full ${getCategoryBadgeClass(cost.category)}">
                    ${cost.category_display}
                </span>
            </td>
            <td class="px-4 py-3 text-gray-700">${cost.description}</td>
            <td class="px-4 py-3 text-right font-semibold text-gray-900">${formatCurrency(cost.amount)}</td>
            <td class="px-4 py-3 text-center text-gray-600">${formatDate(cost.date_incurred)}</td>
            <td class="px-4 py-3 text-center">
                <div class="flex justify-center gap-2">
                    <button onclick="editMobilizationCost(${cost.id})" class="text-blue-600 hover:text-blue-800 transition" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button onclick="deleteMobilizationCost(${cost.id})" class="text-red-600 hover:text-red-800 transition" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Filter costs
function filterCosts() {
    const projectFilter = document.getElementById('projectFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    let filtered = allCosts;

    if (projectFilter) {
        filtered = filtered.filter(cost => cost.project_id == projectFilter);
    }

    if (categoryFilter) {
        filtered = filtered.filter(cost => cost.category === categoryFilter);
    }

    if (searchTerm) {
        filtered = filtered.filter(cost =>
            cost.description.toLowerCase().includes(searchTerm) ||
            cost.project_name.toLowerCase().includes(searchTerm)
        );
    }

    displayCosts(filtered);
}

// Modal functions
function openAddMobilizationModal() {
    document.getElementById('modalTitle').textContent = 'Add Mobilization Cost';
    document.getElementById('mobilizationForm').reset();
    document.getElementById('costId').value = '';
    document.getElementById('dateInput').valueAsDate = new Date();
    document.getElementById('mobilizationModal').classList.remove('hidden');
}

function closeMobilizationModal() {
    document.getElementById('mobilizationModal').classList.add('hidden');
}

function editMobilizationCost(costId) {
    const cost = allCosts.find(c => c.id === costId);
    if (!cost) return;

    document.getElementById('modalTitle').textContent = 'Edit Mobilization Cost';
    document.getElementById('costId').value = cost.id;
    document.getElementById('projectSelect').value = cost.project_id;
    document.getElementById('categorySelect').value = cost.category;
    document.getElementById('descriptionInput').value = cost.description;
    document.getElementById('amountInput').value = cost.amount;
    document.getElementById('dateInput').value = cost.date_incurred;
    document.getElementById('notesInput').value = cost.notes || '';

    document.getElementById('mobilizationModal').classList.remove('hidden');
}

function submitMobilizationForm(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const costId = document.getElementById('costId').value;
    const url = costId
        ? `/projects/api/mobilization-costs/${costId}/`
        : '/projects/api/mobilization-costs/create/';

    const data = {
        project_id: formData.get('project'),
        category: formData.get('category'),
        description: formData.get('description'),
        amount: formData.get('amount'),
        date_incurred: formData.get('date_incurred'),
        notes: formData.get('notes')
    };

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeMobilizationModal();
            loadMobilizationCosts();
            showNotification(costId ? 'Cost updated successfully' : 'Cost added successfully', 'success');
        } else {
            showNotification(data.error || 'An error occurred', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
    });
}

function deleteMobilizationCost(costId) {
    if (!confirm('Are you sure you want to delete this mobilization cost?')) return;

    fetch(`/projects/api/mobilization-costs/${costId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadMobilizationCosts();
            showNotification('Cost deleted successfully', 'success');
        } else {
            showNotification(data.error || 'An error occurred', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
    });
}

// Utility functions
function getCategoryBadgeClass(category) {
    const classes = {
        'EQUIP': 'bg-blue-100 text-blue-800',
        'TRANS': 'bg-purple-100 text-purple-800',
        'LABOR': 'bg-orange-100 text-orange-800',
        'MATER': 'bg-green-100 text-green-800',
        'OTHER': 'bg-gray-100 text-gray-800'
    };
    return classes[category] || 'bg-gray-100 text-gray-800';
}

function formatCurrency(amount) {
    return '₱' + parseFloat(amount).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'});
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type) {
    // Simple notification - you can enhance this with a better UI
    alert(message);
}

// Close modal when clicking outside
document.getElementById('mobilizationModal').addEventListener('click', function(event) {
    if (event.target === this) {
        closeMobilizationModal();
    }
});
</script>
{% endblock %}
