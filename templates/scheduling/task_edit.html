{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8 mb-8">
            <div class="flex items-center space-x-4 mb-6">
                <div class="w-14 h-14 bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Edit Task</h1>
                    <p class="text-gray-600 mt-1">Update task details for "{{ task.task_name }}"</p>
                </div>
            </div>
            
            <!-- Progress Indicator -->
            <div class="flex items-center space-x-4">
                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="form-progress" class="h-full bg-gradient-to-r from-amber-500 to-orange-600 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="auto-save-status" class="flex items-center space-x-2 opacity-0 transition-all duration-500 transform">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-xs font-medium text-green-600">Auto-saved</span>
                    </div>
                    <span id="progress-text" class="text-sm font-medium text-gray-600">0% Complete</span>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <form method="post" enctype="multipart/form-data" id="task-form" class="space-y-0" novalidate>
                {% csrf_token %}
                
                <!-- Form Sections -->
                <div class="divide-y divide-gray-200">
                    <!-- Section 1: Basic Information -->
                    <div class="p-8 bg-gradient-to-r from-blue-50 to-indigo-50">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">1</div>
                            Basic Information
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Scope Selection -->
                            <div class="lg:col-span-2">
                                <label for="{{ form.scope.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-3">
                                    Task Scope <span class="text-red-500">*</span>
                                </label>
                                
                                {{ form.scope|add_class:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-200 appearance-none bg-white" }}
                                
                                <div id="scope-info" class="mt-2 text-sm text-gray-600 opacity-0 transition-opacity duration-200"></div>
                                {% if form.scope.errors %}
                                    <div class="mt-2 text-sm text-red-600">{{ form.scope.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Task Name -->
                            <div class="lg:col-span-2">
                                <label for="{{ form.task_name.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-3">
                                    Task Name <span class="text-red-500">*</span>
                                </label>
                                {{ form.task_name|add_class:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-200" }}
                                <div class="mt-2 text-sm text-gray-500">
                                    <span id="task-name-counter">0</span>/100 characters
                                </div>
                                {% if form.task_name.errors %}
                                    <div class="mt-2 text-sm text-red-600">{{ form.task_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Timeline & Duration -->
                    <div class="p-8">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">2</div>
                            Timeline & Duration
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Start Date -->
                            <div class="space-y-3">
                                <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-semibold text-gray-700">
                                    Start Date <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    {{ form.start_date|add_class:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-200" }}
                                </div>
                                {% if form.start_date.errors %}
                                    <div class="text-sm text-red-600">{{ form.start_date.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- End Date -->
                            <div class="space-y-3">
                                <label for="{{ form.end_date.id_for_label }}" class="block text-sm font-semibold text-gray-700">
                                    End Date <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    {{ form.end_date|add_class:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-200" }}
                                </div>
                                {% if form.end_date.errors %}
                                    <div class="text-sm text-red-600">{{ form.end_date.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Duration (Auto-calculated) -->
                            <div class="space-y-3">
                                <label for="{{ form.duration_days.id_for_label }}" class="block text-sm font-semibold text-gray-700">
                                    Duration (Days)
                                </label>
                                <div class="relative">
                                    {{ form.duration_days|add_class:"w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed" }}
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500">Calculated from start and end dates</p>
                            </div>

                            <!-- Man Hours (Auto-calculated) -->
                            <div class="space-y-3">
                                <label for="{{ form.manhours.id_for_label }}" class="block text-sm font-semibold text-gray-700">
                                    Man Hours
                                </label>
                                <div class="relative">
                                    {{ form.manhours|add_class:"w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed" }}
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500">Duration Ã— 8 hours/day</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Assignment & Weight -->
                    <div class="p-8 bg-gradient-to-r from-purple-50 to-pink-50">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">3</div>
                            Assignment & Priority
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Weight -->
                            <div class="space-y-3">
                                <label for="{{ form.weight.id_for_label }}" class="block text-sm font-semibold text-gray-700">
                                    Task Weight (%) <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    {{ form.weight|add_class:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-200" }}
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                                        <span class="text-gray-400">%</span>
                                    </div>
                                </div>
                                <div id="weight-info" class="text-sm text-gray-600"></div>
                                {% if form.weight.errors %}
                                    <div class="text-sm text-red-600">{{ form.weight.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Project Manager Assignment -->
                            <div class="space-y-3">
                                <label class="block text-sm font-semibold text-gray-700">
                                    Assign To Project Manager
                                </label>
                                <div class="relative">
                                    <input type="text" id="project_manager_input"
                                           placeholder="Search and select a PM..."
                                           value="{% if task.assigned_to %}{{ task.assigned_to.full_name }}{% endif %}"
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-200"
                                           autocomplete="off">
                                    <input type="hidden" name="assigned_to" id="project_manager_id" value="{% if task.assigned_to %}{{ task.assigned_to.id }}{% endif %}">
                                    <ul id="pm_suggestions" class="absolute bg-white border-2 border-gray-200 w-full mt-1 z-50 max-h-60 overflow-y-auto shadow-xl rounded-xl hidden"></ul>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </div>
                                </div>
                               
                                <div id="assigned_pm_display" class="text-sm text-green-600 font-medium">
                                    {% if task.assigned_to %}
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-6 rounded-full overflow-hidden bg-gray-200 flex-shrink-0">
                                            <div class="w-full h-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-xs">
                                                {{ task.assigned_to.full_name|first|upper }}
                                            </div>
                                        </div>
                                        <span>Assigned to: <strong>{{ task.assigned_to.full_name }}</strong> ({{ task.assigned_to.email }})</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="px-8 py-6 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            All fields marked with <span class="text-red-500 font-semibold">*</span> are required
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <a href="{% url 'task_list' project.id token role %}"
                           class="px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all duration-200 flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>Cancel</span>
                        </a>
                        
                        <button type="submit" name="save_task" id="submit-btn"
                                class="px-8 py-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white font-semibold rounded-xl shadow-lg hover:from-amber-700 hover:to-orange-700 transition-all duration-200 transform hover:scale-105 flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Update Task</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Success/Error Messages -->
        {% if messages %}
        <div class="mt-6 space-y-3">
            {% for message in messages %}
            <div class="flex items-center gap-3 p-4 rounded-xl {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}">
                {% if message.tags == 'success' %}
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                {% elif message.tags == 'error' %}
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                {% endif %}
                <span class="text-sm font-medium">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 shadow-2xl flex items-center space-x-4">
        <div class="animate-spin rounded-full h-8 w-8 border-4 border-amber-500 border-t-transparent"></div>
        <span class="text-gray-700 font-medium">Updating task...</span>
    </div>
</div>

<style>
    .form-error {
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
    }
    
    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .animate-shake {
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .suggestion-item:hover {
        background-color: #f3f4f6;
        transform: translateX(2px);
    }
</style>

<!-- Task Data for JavaScript -->
<script id="task-data" type="application/json">
{
    "assignedTo": {
        {% if task.assigned_to %}
        "id": {{ task.assigned_to.id }},
        "name": "{{ task.assigned_to.full_name|escapejs }}",
        "email": "{{ task.assigned_to.email|escapejs }}"
        {% else %}
        "id": null,
        "name": "",
        "email": ""
        {% endif %}
    },
    "initialValues": {
        "taskName": "{{ task.task_name|escapejs }}",
        "scope": "{{ task.scope|escapejs }}",
        "weight": {{ task.weight|default:0 }},
        "startDate": "{{ task.start_date|date:'Y-m-d'|default:'' }}",
        "endDate": "{{ task.end_date|date:'Y-m-d'|default:'' }}",
        "durationDays": {{ task.duration_days|default:0 }},
        "manhours": {{ task.manhours|default:0 }}
    }
}
</script>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Get task data
    const taskData = JSON.parse(document.getElementById('task-data').textContent);
    
    // Form elements
    const form = document.getElementById("task-form");
    const startInput = document.getElementById("{{ form.start_date.id_for_label }}");
    const endInput = document.getElementById("{{ form.end_date.id_for_label }}");
    const daysInput = document.getElementById("{{ form.duration_days.id_for_label }}");
    const hoursInput = document.getElementById("{{ form.manhours.id_for_label }}");
    const weightInput = document.getElementById("{{ form.weight.id_for_label }}");
    const scopeSelect = document.getElementById("{{ form.scope.id_for_label }}");
    const taskNameInput = document.getElementById("{{ form.task_name.id_for_label }}");
    const pmInput = document.getElementById("project_manager_input");
    const pmIdInput = document.getElementById("project_manager_id");
    const suggestionsBox = document.getElementById("pm_suggestions");
    const assignedDisplay = document.getElementById("assigned_pm_display");
    const submitBtn = document.getElementById("submit-btn");
    const progressBar = document.getElementById("form-progress");
    const progressText = document.getElementById("progress-text");

    // Auto-save functionality
    let autoSaveTimer = null;
    let formHasChanges = false;

    function autoSave() {
        try {
            const formData = {
                scope: scopeSelect ? scopeSelect.value : '',
                task_name: taskNameInput ? taskNameInput.value : '',
                start_date: startInput ? startInput.value : '',
                end_date: endInput ? endInput.value : '',
                weight: weightInput ? weightInput.value : '',
                assigned_to: pmIdInput ? pmIdInput.value : '',
                assigned_to_name: pmInput ? pmInput.value : '',
                duration_days: daysInput ? daysInput.value : '',
                manhours: hoursInput ? hoursInput.value : '',
                timestamp: new Date().toISOString(),
                task_id: "{{ task.id }}"
            };
            
            const hasContent = formData.task_name || formData.scope || formData.start_date || formData.end_date || formData.weight;
            if (!hasContent) return;
            
            const currentData = JSON.stringify(formData);
            const existingData = localStorage.getItem("task_edit_draft_{{ task.id }}");
            
            if (currentData !== existingData) {
                localStorage.setItem("task_edit_draft_{{ task.id }}", currentData);
                showAutoSaveStatus();
                formHasChanges = false;
            }
            
        } catch (error) {
            console.warn("Auto-save unavailable:", error);
        }
    }

    function showAutoSaveStatus() {
        const statusElement = document.getElementById("auto-save-status");
        if (!statusElement) {
            showFloatingNotification();
            return;
        }
        
        statusElement.style.display = "flex";
        statusElement.style.opacity = "1";
        statusElement.style.transform = "scale(1.05)";
        
        const dot = statusElement.querySelector('.bg-green-500');
        if (dot) {
            dot.classList.add('animate-pulse');
        }
        
        setTimeout(() => {
            statusElement.style.transform = "scale(1)";
        }, 200);
        
        setTimeout(() => {
            statusElement.style.opacity = "0";
            if (dot) {
                dot.classList.remove('animate-pulse');
            }
        }, 3000);
        
        showFloatingNotification();
    }

    function showFloatingNotification() {
        const existing = document.getElementById('floating-autosave');
        if (existing) {
            existing.remove();
        }
        
        const notification = document.createElement('div');
        notification.id = 'floating-autosave';
        notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-sm font-medium">Changes auto-saved</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    function trackFormChanges() {
        formHasChanges = true;
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(autoSave, 2000);
    }

    // Progress tracking
    function updateProgress() {
        if (!progressBar || !progressText || !submitBtn) return;
        
        const requiredFields = [scopeSelect, taskNameInput, startInput, endInput, weightInput].filter(f => f);
        const completed = requiredFields.filter(field => field.value.trim()).length;
        const percentage = Math.round((completed / requiredFields.length) * 100);
        
        progressBar.style.width = percentage + '%';
        progressText.textContent = percentage + '% Complete';
        submitBtn.disabled = percentage < 100;
    }

    // Auto-calculate duration and hours
    function calculateDuration() {
        if (!startInput || !endInput || !daysInput || !hoursInput) return;
        
        const start = new Date(startInput.value);
        const end = new Date(endInput.value);
        
        if (start && end && !isNaN(start) && !isNaN(end)) {
            if (end < start) {
                showFieldError(endInput, "End date cannot be earlier than start date");
                daysInput.value = "";
                hoursInput.value = "";
                return;
            }
            
            clearFieldError(endInput);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const hours = days * 8;
            
            daysInput.value = days;
            hoursInput.value = hours;
        } else {
            daysInput.value = "";
            hoursInput.value = "";
        }
    }

    // Task name character counter
    function updateCharacterCounter() {
        if (!taskNameInput) return;
        
        const count = taskNameInput.value.length;
        const counter = document.getElementById("task-name-counter");
        if (counter) counter.textContent = count;
        
        if (count > 100) {
            if (counter) counter.parentElement.classList.add("text-red-500");
            showFieldError(taskNameInput, "Task name cannot exceed 100 characters");
        } else {
            if (counter) counter.parentElement.classList.remove("text-red-500");
            clearFieldError(taskNameInput);
        }
    }

    // Scope selection info
    function updateScopeInfo() {
        if (!scopeSelect) return;
        
        const selectedOption = scopeSelect.options[scopeSelect.selectedIndex];
        const infoDiv = document.getElementById("scope-info");
        
        if (selectedOption && selectedOption.value && infoDiv) {
            infoDiv.innerHTML = `<div class="flex items-center space-x-2">
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span>Selected scope: <strong>${selectedOption.textContent}</strong></span>
            </div>`;
            infoDiv.style.opacity = "1";
        } else if (infoDiv) {
            infoDiv.style.opacity = "0";
        }
    }

    // Weight validation
    function validateWeight() {
        if (!weightInput) return;
        
        const weight = parseFloat(weightInput.value);
        const infoDiv = document.getElementById("weight-info");

        if (!infoDiv || !weight || isNaN(weight)) {
            if (infoDiv) infoDiv.innerHTML = "";
            return;
        }

        if (weight < 0 || weight > 100) {
            infoDiv.innerHTML = `<div class="text-red-500 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span>Weight must be between 0% and 100%</span>
            </div>`;
            showFieldError(weightInput, "Invalid weight percentage");
        } else {
            infoDiv.innerHTML = `<div class="text-green-600 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span>Valid weight: ${weight}%</span>
            </div>`;
            clearFieldError(weightInput);
        }
    }

    // Project Manager search functionality
    async function fetchProjectManagers(query) {
        try {
            const response = await fetch(`/projects/search/project-managers/?q=${encodeURIComponent(query)}`);
            if (!response.ok) return [];
            return await response.json();
        } catch (error) {
            console.error('Error fetching PMs:', error);
            return [];
        }
    }

    // Error handling functions
    function showFieldError(field, message) {
        if (!field) return;
        field.classList.add("form-error", "animate-shake");
        
        const existingError = field.parentElement.querySelector(".error-message");
        if (existingError) existingError.remove();
        
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = message;
        field.parentElement.appendChild(errorDiv);
        
        setTimeout(() => field.classList.remove("animate-shake"), 500);
    }

    function clearFieldError(field) {
        if (!field) return;
        field.classList.remove("form-error");
        const errorMsg = field.parentElement.querySelector(".error-message");
        if (errorMsg) errorMsg.remove();
    }

    // Event listeners with null checks
    if (startInput) {
        startInput.addEventListener("change", function() {
            calculateDuration();
            updateProgress();
            trackFormChanges();
        });
    }

    if (endInput) {
        endInput.addEventListener("change", function() {
            calculateDuration();
            updateProgress();
            trackFormChanges();
        });
    }

    if (taskNameInput) {
        taskNameInput.addEventListener("input", function() {
            updateCharacterCounter();
            updateProgress();
            trackFormChanges();
        });
    }

    if (scopeSelect) {
        scopeSelect.addEventListener("change", function() {
            updateScopeInfo();
            updateProgress();
            trackFormChanges();
        });
    }

    if (weightInput) {
        weightInput.addEventListener("input", function() {
            validateWeight();
            updateProgress();
            trackFormChanges();
        });
    }

    // Project Manager search
    if (pmInput && suggestionsBox) {
        pmInput.addEventListener("input", async function() {
            const query = this.value.trim();
            suggestionsBox.innerHTML = "";
            trackFormChanges();

            if (!query) {
                suggestionsBox.classList.add("hidden");
                return;
            }

            const results = await fetchProjectManagers(query);
            if (results.length === 0) {
                suggestionsBox.innerHTML = `<li class="px-4 py-3 text-gray-500 italic">No project managers found</li>`;
                suggestionsBox.classList.remove("hidden");
                return;
            }

            results.forEach(pm => {
                const li = document.createElement("li");
                li.className = "px-4 py-3 cursor-pointer hover:bg-gray-50 transition-all duration-200 suggestion-item border-b border-gray-100 last:border-b-0";
                
                const avatarUrl = pm.avatar ? `/media/${pm.avatar}` : null;
                
                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-200 flex-shrink-0">
                            ${avatarUrl ? 
                                `<img src="${avatarUrl}" alt="${pm.full_name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-lg">
                                    ${pm.full_name.charAt(0).toUpperCase()}
                                </div>`
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 truncate">${pm.full_name}</div>
                            <div class="text-sm text-gray-500 truncate">${pm.email}</div>
                        </div>
                    </div>
                `;
                
                li.addEventListener("click", function() {
                    pmInput.value = pm.full_name;
                    if (pmIdInput) pmIdInput.value = pm.id;
                    
                    if (assignedDisplay) {
                        assignedDisplay.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <div class="w-6 h-6 rounded-full overflow-hidden bg-gray-200 flex-shrink-0">
                                    ${avatarUrl ? 
                                        `<img src="${avatarUrl}" alt="${pm.full_name}" class="w-full h-full object-cover">` :
                                        `<div class="w-full h-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-xs">
                                            ${pm.full_name.charAt(0).toUpperCase()}
                                        </div>`
                                    }
                                </div>
                                <span>Assigned to: <strong>${pm.full_name}</strong> (${pm.email})</span>
                            </div>
                        `;
                    }
                    suggestionsBox.classList.add("hidden");
                    trackFormChanges();
                });
                
                suggestionsBox.appendChild(li);
            });

            suggestionsBox.classList.remove("hidden");
        });
    }

    // Close suggestions when clicking outside
    document.addEventListener("click", function(e) {
        if (pmInput && suggestionsBox && !pmInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
            suggestionsBox.classList.add("hidden");
        }
    });

    // Form submission
    if (form) {
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            
            const loadingOverlay = document.getElementById("loading-overlay");
            if (loadingOverlay) {
                loadingOverlay.classList.remove("hidden");
            }
            
            // Clear auto-save draft on submit
            localStorage.removeItem("task_edit_draft_{{ task.id }}");
            
            setTimeout(() => form.submit(), 1000);
        });
    }

    // Auto-save every 2 minutes
    setInterval(autoSave, 120000);

    // Track changes on all form fields
    const formFields = [scopeSelect, taskNameInput, startInput, endInput, weightInput, pmInput].filter(field => field !== null);
    
    formFields.forEach(field => {
        if (field) {
            field.addEventListener("input", trackFormChanges);
            field.addEventListener("change", trackFormChanges);
        }
    });

    // Initialize form with current values
    updateProgress();
    updateCharacterCounter();
    updateScopeInfo();
    validateWeight();
    calculateDuration();
    
    // Set initial assignment display if assigned
    if (taskData.assignedTo.id && pmInput && assignedDisplay) {
        pmInput.value = taskData.assignedTo.name;
        pmIdInput.value = taskData.assignedTo.id;
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    const existing = document.getElementById('floating-autosave');
    if (existing) {
        existing.remove();
    }
});
</script>
{% endblock %}